function AdManager() {
    var debugMode = false;
    var dfpId = 175840252;

    // Holds DFP defined slots once they've been written to the DOM
    var slots = [];

    var amazon_sizes ='';
    var adsizes= '';
    var amazonSlots = [];

    // global targets across all ads?
    var globalTargeting = { };
    var utmSource = getQueryParam('utm_source');
    if(utmSource) {
        globalTargeting['utmSource'] = utmSource;
    }

    // be a singleton
    if ( arguments.callee._singletonInstance )
        return arguments.callee._singletonInstance;
    arguments.callee._singletonInstance = this;

    /**
     * Define Ad Units here
     *
     * If an ad should be left out for a certain breakpoint
     * just exclude that breakpoint altogether
     *
     * *Ad Categories (path suffix)*
     * home
     * blogs
     */
    var adUnits = { // NAMING CONVENTION: SECTION_TYPE_POSITION_NUMBER -> ARTICLE_LEADERBOARD_STUDIOS

        //HOME
        'home_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90],[970,250],[970,90]] },
        },
        'home_leaderboard_hero':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300, 250]] },
        },
        'home_leaderboard_instagram':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300, 250]] },
        },
        'home_leaderboard_sections':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300, 250]] },
        },
        'home_leaderboard_sponsored_story':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90]] },
            mobile:		{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300, 250]] },
        },
        'home_leaderboard_trending':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90],[970,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300,250],[320,50],[300,50]]},
        },
        'home_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[320,50],[300,50]]},
        },
        'home_vertical_hero':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300,250]] },
        },
        'home_vertical_the_latest':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300,250],[300,600]] },
        },
        'home_vertical_sections':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300,250],[300,600]] },
        },
        'home_daily_floss_ad':{
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300,250],[300,600]] },
            mobile:		{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[300, 250]] },
        },
        'home_leaderboard_latest_left_rail_articles':{
            mobile:		{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[320, 50]] },
        },

        //UPDATED ADS ABOVE, ORIGINAL BELOW
        'skin-hp-ad':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/homepage', sizes: [[3,3]] },
        },

        // LONGFORM
        'div-gpt-ad-1557322634291-0': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/Top', sizes: [[728,90],[970,250]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/Top', sizes: [[728,90],[970,250]] },
        },
        'div-gpt-ad-1557322893360-0': {
            desktop: { path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/NativeFluid', sizes: [['fluid']] },
            tablet: { path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/NativeFluid', sizes: [['fluid']] },
        },
        'div-gpt-ad-1557323196909-0': {
            mobile: { path: '/'+dfpId+'/mentalfloss.com/LongformMobile/320x50', sizes: [[320,50]]},
            desktop: { path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/300x250', sizes:  [[320, 250], [468, 60]]}
        },
        'longform_mm': {
            mobile: { path: '/'+dfpId+'/mentalfloss.com/LongformMobile/300x250', sizes: [[300,250]]},
            desktop: { path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/300x250', sizes: [[320, 250], [468, 60]]}
        },
        'longform_mm_without_prebid': {
            mobile: { path: '/'+dfpId+'/mentalfloss.com/LongformMobile/300x250_without_prebid', sizes: [[300,250]]}
        },
        'div-gpt-ad-1557323469676-0': {
            mobile: { path: '/'+dfpId+'/mentalfloss.com/LongformMobile/NativeFluid', sizes: [['fluid']]}
        },
        'longform_vertical_right_rail_1': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/300x250', sizes:  [[300,250]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/LongformDesktop/300x250', sizes:  [[300,250]] },
        },
        'longform_correction_bid_service': {
            mobile: { path: ''+dfpId+'/mentalfloss.com/LongformMobile/300x250_correction_bid_service', sizes: [[300,250]] }
        },

        //ARTICLE
        'article_video_in_content':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[640, 360]]},
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[640, 360]]},
        },
        'article_sponsor_unit': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[380,70],[350, 60], [230, 60]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[380,70],[350, 60], [230, 60]] },
            mobile:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[380,70],[350, 60], [230, 60]] },
        },
        'article_leaderboard_top': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'article_leaderboard_related_notch': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/article', sizes: [[728,90]] },
        },
        'article_leaderboard_after_articles': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/article', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/article', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/article', sizes: [[300,250]] },
        },
        'article_leaderboard_sections': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/article', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/article', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/article', sizes:  [[300,250]] },
        },
        'article_leaderboard_header_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,50]]},
        },
        'mars_afg_right_rail': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/mars_afg', sizes:  [[300,250],[300,600]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/mars_afg', sizes:  [[300,250],[300,600]] },
            mobile:	    { path: '/'+dfpId+'/mentalfloss.com/mars_afg', sizes:  [[300,250]] },
        },
        'article_vertical_right_rail_1': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_right_rail_12': {
            desktop: {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_13': {
            desktop: {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_14': {
            desktop: {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_15': {
            desktop: {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_16': {
            desktop: {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_2': {
            desktop:    {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_right_rail_22': {
            desktop:    {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_23': {
            desktop:    {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_24': {
            desktop:    {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_25': {
            desktop:    {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_26': {
            desktop:    {path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250], [300, 600]]},
        },
        'article_vertical_right_rail_3': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_right_rail_32': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_right_rail_33': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_right_rail_34': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_right_rail_35': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_right_rail_36': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes:  [[300,250],[300,600]] },
        },
        'article_vertical_sections': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/article', sizes:  [[300,250],[300,600]] },
        },
        'article_in_text_1': {
            mobile:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250],[320,50]] },
        },
        'article_in_text_2': {
            mobile:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,50],[300,250]] },
        },
        'article_in_text_3': {
            mobile:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,250]] },
        },
        'article_in_text_4': {
            mobile:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,250]] },
        },
        'article_in_text_5': {
            mobile:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,250]] },
        },
        'article_in_text_6': {
            mobile:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,250]] },
        },
        'article_mobile_more_stories_1': {
            mobile: { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250]] },
        },
        'article_mobile_more_stories_2': {
            mobile:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250]] },
        },
        'article_mobile_more_stories_3': {
            mobile:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250]] },
        },
        'article_replace_brightcove': {
            desktop:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[777,100]] },
        },

        //SHOPPING LIST
        'best_deals_right_rail': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes:  [[300,250],[300,600]] },
        },
        'best_deals_in_list_ad_1': {
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[728,90]] },
            mobile:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[320,50],[300,250]] },
        },
        'best_deals_in_list_ad_2': {
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[728,90]] },
            mobile:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[320,50],[300,250]] },
        },
        'best_deals_in_list_ad_3': {
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[728,90]] },
            mobile:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[320,50],[300,250]] },
        },
        'best_deals_in_list_ad_4': {
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[728,90]] },
            mobile:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[320,50],[300,250]] },
        },
        'best_deals_in_list_ad_5': {
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[728,90]] },
            mobile:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[320,50],[300,250]] },
        },
        'best_deals_in_list_ad_6': {
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[728,90]] },
            mobile:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[320,50],[300,250]] },
        },
        'gift_guides_right_rail': {
            desktop:   { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes:  [[300,250],[300,600]] },
        },
        'shopping_list_sponsor_ad': {
            desktop:   { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[380,70],[350,60],[230,60]] },
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[380,70],[350,60],[230,60]] },
            mobile:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[380,70],[350,60],[230,60]] },
        },
        'shopping_list_top_leaderboard': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/shopping', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },


        //REDESIGN ADS ABOVE, ORIGINAL ADS BELOW

        //AMAZING FACT GENERATOR
        'afg_square_right_rail': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/amazingfactgenerator', sizes: [[300,250],[300,600]]},
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/amazingfactgenerator', sizes: [[728,90]]},
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/amazingfactgenerator', sizes: [[320,50]]},
        },
        'afg_interstitial_ad':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/amazingfactgenerator', sizes: [[300,250]]},
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/amazingfactgenerator', sizes: [[300,250]]},
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/amazingfactgenerator', sizes: [[300,250]]},
        },

        //AUTHORS LIST / AUTHOR DETAIL
        'author_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/authors', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'author_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/authors', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/authors', sizes: [[320,50],[300,50]]},
        },
        'author_right_rail_top': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/authors', sizes: [[300,250],[300,600]]},
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/authors', sizes: [[300,250],[300,600]]},
        },

        //QUIZZES
        'quiz_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'quiz_square_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[300, 250], [300, 600], [480, 600]] },
        },
        'quiz_square_right_rail':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[300, 250], [300, 600], [480, 600]] },
        },
        'quiz_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[320,50],[300,50]] },
        },
        'quiz_detail_right_rail':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[300, 250], [300, 600]] },
        },
        'quiz_detail_bottom_leaderboard':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'quiz_detail_top_leaderboard': {
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[320,50],[300,50]] },
        },
        'quiz_detail_sponsor_logo_upper': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[380,70],[350, 60], [230, 60]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[380,70],[350, 60], [230, 60]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[380,70],[350, 60], [230, 60]] },
        },
        'quiz_detail_sponsor_logo_lower': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[380,70],[350, 60], [230, 60]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[380,70],[350, 60], [230, 60]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[380,70],[350, 60], [230, 60]] },
        },

        //PUZZLES
        'puzzle_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,50]]},
        },
        'puzzle_square_right_rail':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250],[300,600]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250],[300,600]] },
        },


        //SECTION PAGE
        'section_sponsor_unit': {
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[380,70],[350,60],[230,60]] },
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[380,70],[350,60],[230,60]] },
            mobile:	    { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[380,70],[350,60],[230,60]] },
        },
        'section_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'section_leaderboard_article_list_1':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[300, 250]] },
        },
        'section_leaderboard_article_list_2':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[300, 250]] },
        },
        'section_leaderboard_article_list_3':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90]] },
        },
        'section_leaderboard_article_list_4':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90]] },
        },
        'section_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[320,50],[300,50]]},
        },
        'section_vertical_article_list':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[300,250],[300,600]] },
        },
        'section_vertical_sections':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[300,250],[300,600]] },
        },
        'section_vertical_top_section':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/section', sizes: [[300,250]]},
        },

        //SEARCH
        'search_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'search_square_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/search', sizes: [[300,250],[300,600]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/search', sizes: [[300,250],[300,600]] },
        },
        'search_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,50]]},
        },

        'skin-ad':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com', sizes: [[3,3]] },
        },

        //GALLERY ARTICLE
        'gallery_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'gallery_interstitial_ad_1':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_2':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_3':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_4':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_5':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_6':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_7':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_8':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_9':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_interstitial_ad_10':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[300,250]] },
        },
        'gallery_leaderboard_footer_fixed': {
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320,50],[300,50]]},
        },
        'gallery_in_list_leaderboard_1':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_2':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_3':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_4':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_5':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_6':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_7':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_8':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_9':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_in_list_leaderboard_10':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },
        'gallery_bottom_leaderboard':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/photos', sizes: [[320, 50],[320, 568],[320, 250]] },
        },

        //KENNECTION
        'kennection_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/quizzes', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'kennection_square_right_rail':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/kennection', sizes: [[300, 250], [300, 600], [480, 600]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/kennection', sizes: [[300, 250], [300, 600], [480, 600]] },
        },
        'kennection_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,50]]},
        },
        'kennection_browsi_1': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/kennection/browsi_1', sizes: [[320,50]]}
        },
        'kennection_browsi_2': {
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/kennection/browsi_2', sizes: [[300,250]]}
        },

        //VIDEO
        'video_leaderboard_top':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
        'video_leaderboard_list_1':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[300, 250]] },
        },
        'video_leaderboard_list_2':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[300, 250]] },
        },
        'video_leaderboard_list_3':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[728,90],[970,90],[920,90],[970,250]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[300, 250]] },
        },
        'video_leaderboard_footer_fixed': {
            tablet:	    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[728,90]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[320,50],[300,50]]},
        },
        'video_vertical_list_1':{
            desktop:	{ path: '/'+dfpId+'/mentalfloss.com/video', sizes: [[300, 250], [300, 600], [480, 600]] },
        },
        'video_vertical_right_rail':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250],[300,600]] },
            tablet:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250],[300,600]] },
            mobile:     { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300, 250]] },
        },
        'video_tablet_vertical_right_rail':{
            tablet:    { path: '/'+dfpId+'/mentalfloss.com/blogs', sizes: [[300,250],[300,600]] },
        },

        //ERROR PAGE
        'error_page_top_leaderboard':{
            desktop:    { path: '/'+dfpId+'/mentalfloss.com/error', sizes: [[728,90],[970,90],[920,90],[970,250]] },
        },
    };


    /**************
     * Public API *
     **************/

    this.setGlobalTarget = function(key, val) {
        globalTargeting[key] = val;
        return this;
    };
    this.setGlobalTargets = function(pairs) {
        for(p in pairs) {
            if(pairs.hasOwnProperty(p)) this.setGlobalTarget(p, pairs[p]);
        }
    };


    this.getGlobalTargets = function() {
        return globalTargeting;
    };

    this.getSlots = function() {
        return slots;
    };

    //This doesn't actually refresh based on the "position" targeting parameter, but just index in the array
    this.refreshAd = function(position) {
        var refreshSlot = AdManager.getSlots()[position];
        googletag.pubads().disableInitialLoad();
        triggerAuction([refreshSlot]);
    };

    this.refreshAdRightRail = function(currentId, device) {
        if (jQuery('#' + currentId).attr('data-next')) {
            adId = jQuery('#' + currentId).attr('data-next');
            jQuery("#" + currentId).replaceWith(jQuery("#" + adId));
            AdManager.writeSingleAdForId(adId, device);
        }

    };

    this.refreshAllAds = function() {
        try {
            sendAdserverRequest();
            // googletag.pubads().refresh();
        }
        catch(ex) {
            debug("Error refreshing ads-" + ex.toString());
        }
    };

    this.clearTargeting = function(position) {
        var clearSlot = AdManager.getSlots()[position];
        clearSlot.clearTargeting();
    };

    this.setManualTargeting = function(position, key, value) {
        var setManualTargetingSlot = AdManager.getSlots()[position];
        setManualTargetingSlot.setTargeting(key, value);
    };

    this.writeAllAds = function() {
        if(window.disableAds) return;
        var device = MentalFloss.getCurrentDevice();
        var ads = getAdsForDevice(device);
        for(var i=0; i < ads.length; i++) {
            var targets = getTargetsFromAdEl(ads[i]);

            var defer = ads[i].hasAttribute('data-defer') && ads[i].getAttribute('data-defer') == "true";
            if(!defer) {
                try {
                    writeAd(ads[i], device, targets);
                }
                catch(e) {
                    debug("ERROR");
                    debug(e);
                }

            }
        }
        slots = this.getSlots();
        googletag.cmd.push(function(){
            googletag.pubads().disableInitialLoad();
            triggerAuction(slots);
        });
        return this;
    };

    this.writeSingleAd =  function(ad, device, targets) {
        if(window.disableAds) return;
        slots = this.getSlots();
        writeAd(ad, device, targets);
        googletag.cmd.push(function () {
            googletag.pubads().disableInitialLoad();
            triggerAuction(slots);
        });

        return this;
    };

    this.writeSingleAdForId = function(id, device) {
        var el = document.getElementById(id);
        return this.writeSingleAdForEl(el, device);

    };

    this.writeSingleAdForEl = function(el, device) {
        if(window.disableAds) return;
        if(el == null) {
            console.error("Failed to write single ad for element: " + id + " device: "+device);
            return this;
        }
        try {
            var targets = AdManager.getTargetingForSingleEl(el);
            writeAd(el, device, targets);
            googletag.cmd.push(function(){
                googletag.pubads().disableInitialLoad();
                triggerAuction(amazonSlots);
            });
        }
        catch (ex) {
            console.error(ex);
            console.error(el);
        }
        return this;
    };

    this.getTargetingForSingleEl = function(ad) {
        var ret = {};
        if(isElement(ad) && ad.hasAttribute('data-targets')) {
            var targets = ad.getAttribute('data-targets');
            targets = targets.split(';');
            for(x=0; x < targets.length; x++) {
                var pair = targets[x].split(':');
                var key = pair[0];
                var val = pair[1];
                ret[key] = val;
            }
        }
        return ret;
    };

    this.getSlotByDivId = function(divId) {
        let slot = false;
        AdManager.getSlots().forEach(function(s){
            let domId = s.getSlotId().getDomId();
            if(domId == divId) slot = s;
        });
        return slot;
    };

    this.replaceWithHouseAds = function(sizes, divId){
        jQuery.each(sizes, function( index, value ) {
            if(jQuery.inArray(728, value) !== -1) {
                debug('this ad is 728x90 for ' + divId);
                jQuery( "#" + divId ).replaceWith(jQuery('#houseAd_728x90').clone());
            }
            else if(jQuery.inArray(600, value) !== -1) {
                jQuery( "#" + divId ).replaceWith(jQuery('#houseAd_300x600').clone());
                debug('this ad is 300x600 ' + divId);
            }
            else if(jQuery.inArray(250, value) !== -1) {
                jQuery( "#" + divId ).replaceWith(jQuery('#houseAd_300x250').clone());
                debug('this ad is 300x250 ' + divId);
            }
            else if(jQuery.inArray(50, value) !== -1) {
                jQuery( "#" + divId ).replaceWith(jQuery('#houseAd_320x50').clone());
                debug('this ad is 320x50 ' + divId);
            }
        });
    };

    /**************/

    // Takes an array of GPT slots and triggers an auction
    var triggerAuction = function(s) {
        if(window.disableAds) return;
        apstag.setDisplayBids();
        googletag.pubads().refresh([s], {changeCorrelator: false});
    };

    var pushAds = function(ad, adType, divId, targeting, amazonSlot){
        if(window.disableAds) return;
        googletag.cmd.push(function () {
            var slot = false;
            if (adType === 'oop') {
                slot = googletag.defineOutOfPageSlot(ad.path, divId).addService(googletag.pubads());
                debug('defineOutOfPageSlot ['+divId+']');
            } else {
                try {
                    slot = googletag.defineSlot(ad.path, ad.sizes, divId).addService(googletag.pubads());
                    debug('defineSlot [' + divId +']');
                }
                catch(ex) {
                    debug('ERROR ['+divId+']: '+ex.message);
                }

            }
            if(slot) {
                var keys = Object.keys(targeting);
                keys.forEach(function (key) {
                    slot.setTargeting(key, targeting[key]);
                });

                setupIframeSandboxing();


                googletag.pubads().enableSingleRequest();
                apstag.setDisplayBids();
                googletag.display(divId);
                googletag.pubads().refresh([slot], {changeCorrelator: false});
                googletag.display(divId);

                slots.push(slot);
                amazonSlots.push(amazonSlot);
            }

        });

    };


    // looks up and writes the device-specific ad if configured,
    // replacing the dom elemenet el with an ad-enabled one
    var writeAd = function(el, device, targeting) {
        if (!isElement(el) || window.disableAds) {
            return;
        }
        var adId = el.getAttribute('data-ad-id');
        var ads = lookup(adId, adUnits);
        var amazonSlot;

        var adType = "";
        if (el.getAttribute('data-type-ad')) {
            adType = el.getAttribute('data-type-ad');
        }

        if (ads) {
            var ad = lookup(device, ads);
            debug("looked up ad ["+adId+"]");
            debug(ad);
            if (ad) {
                var adDiv = document.createElement("div");
                if (adType === 'oop') {
                    var divId = adId;
                }
                else {
                    var divId = adId + "-" + device + "-" + slots.length;
                    if (el.hasAttribute('data-index')) {
                        divId += '-' + el.getAttribute('data-index');
                    }
                }

                debug("New Ad div id: " + divId);
                adDiv.setAttribute('id', divId);

                if (el && el.parentNode) {
                    adDiv.setAttribute('class', el.getAttribute('class'));
                    if (el.getAttribute('data-next')) {
                        adDiv.setAttribute('data-next', el.getAttribute('data-next'));
                    }
                    el.parentNode.replaceChild(adDiv, el);
                }
                else { // if original target can't be found, append to the body
                    var adWrapper = document.createElement('div');
                    adWrapper.setAttribute('class', 'body-ad-wrapper');
                    adWrapper.appendChild(adDiv);
                    document.getElementsByTagName('body')[0].appendChild(adWrapper);
                }

                // merge targeting with global targeting
                if (typeof targeting != 'object') targeting = {};
                var comment = 'TARGETING [' + divId + ']:\n';
                for (var attr in globalTargeting) {
                    targeting[attr] = globalTargeting[attr];
                }
                for (var attr in targeting) {
                    if (attr) {
                        comment += '- ' + attr + ' = ' + targeting[attr] + '\n';
                    }
                }

                if (ad.sizes.length > 0) {
                    comment += "- [";
                    for (i = 0; i < ad.sizes.length; i++) {
                        if (Array.isArray(ad.sizes[i])) {
                            comment += ad.sizes[i].join('x') + ",";
                        }
                        else {
                            comment += ad.sizes[i] + ",";
                        }
                    }
                    comment = comment.replace(/,$/, '') + "]";
                }
                comment = document.createComment(comment);
                adDiv.parentNode.insertBefore(comment, adDiv);
                var amzSizes = ad.sizes.filter(function(size) {
                    return (!(size[0] === 1 && size[1] === 1))
                });
                amazonSlot = {
                    slotID: divId,
                    sizes: amzSizes,
                    slotName: ad.path,
                };

                if (replaceAds === 'true') {
                    AdManager.replaceWithHouseAds(ad.sizes, divId);
                }
                else {
                    apstag.fetchBids({
                        slots: [amazonSlot],
                        timeout: 2e3
                    }, function (bids) {
                        pushAds(ad, adType, divId, targeting, amazonSlot);
                    });
                }
            }
        }
        else {
                debug("No ad configured for " + adId + " / " + device);
        }
    };

    // generic lookup function to find the value of a key value pair
    var lookup = function(id, obj) {
        var lookup = {};
        for (var i = 0, len = obj.length; i < len; i++) {
            lookup[obj[i].id] = obj[i];
        }
        return obj[id];
    };

    var isElement = function(o){
        return (typeof HTMLElement === "object" ? o instanceof HTMLElement : //DOM2
            o && typeof o === "object" && o !== null && o.nodeType === 1 && typeof o.nodeName==="string"
        );
    };

    var getAdsForDevice = function(device) {
        var allAds = document.getElementsByClassName('managed-ad');
        var ads = [];
        for(i=0; i < allAds.length; i++) {
            var adDevice = allAds[i].getAttribute('data-device');
            if(adDevice == device) {
                ads.push(allAds[i]);
            }
        }
        return ads;
    };

    var getTargetsFromAdEl = function(ad) {
        var targets = ad.getAttribute('data-targets');
        var ret = {};
        if(targets) {
            targets = targets.split(';');
            for(x=0; x < targets.length; x++) {
                var pair = targets[x].split(':');
                if(pair.length > 0) {
                    var key = pair[0];
                    var val = pair[1];
                    ret[key] = val;
                }
            }
        }
        return ret;
    };

    var debug = function(msg) {
        if(debugMode) {
            mfdebug(msg);
        }
    };

}

function mfdebug(msg) {
    return; // uncomment to see debug messages in console
    console.log(msg);
}

// need to shim googletag here to add sandboxing to rendering
 var SANDBOX_ALLOWED = [
     // some ads track user behavior by perfoming a form submit, or have a lead capture.
     // note that we may want to experiment with removing this permission, since it could
     // potentially be used for redirection
     'forms',
     'same-origin',
     'scripts',
     'popups',
     'top-navigation',
     'top-navigation-by-user-activation',// required so that ads can open landing pages via window.open()
];

// convert these properties into a sandbox property string
// see here for an explanation of the values: https://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/
var SANDBOX_PROPERTY = jQuery.map(SANDBOX_ALLOWED, function(value) {
    return 'allow-' + value;
}).join(' ');

/**
 * Shim Element#appendChild,
 * which is used inside the googletag pubads SDK
 * to append the new ad iframe to the document.
*/
function setupIframeSandboxing() {
    var Element = window.Element; // Element is the superclass of all DOM elements (eg <div>)
    var appendChild = Element.prototype.appendChild; // get the original/native implementation
    // replace the native method on the Element's prototype
    // with our own logic
    Element.prototype.appendChild = function(e) {
        try {
            // when used by googletag, 'this' will be an adslot div, e.g. having
            // an id like google_ads_iframe/1234/my-unit. We only want to add the sandbox tag to IFRAMEs
            if (!this.id || this.id.indexOf('google_ads_iframe') === -1 || !e || e.tagName !== 'IFRAME') {
                return appendChild.call(this, e);
            }
            // set the sandbox property, which will be a string
            // like 'allow-scripts allow-popups' -- see above
            e.setAttribute('sandbox', SANDBOX_PROPERTY);
        }
        catch (e) {
            // do nothing
        }
        return appendChild.call(this, e);
     };
}

function insertBrowsiTag() {
     mfdebug("+++ Inserting browsi tag");
     let browsiTag = document.createElement('script');
     browsiTag.id = "browsi-tag";
     browsiTag.src = 'https://middycdn-a.akamaihd.net/bootstrap/bootstrap.js';
     browsiTag.dataset.pubkey = "minutemedia";
     browsiTag.dataset.sitekey = "mentalfloss";
     browsiTag.async = true;
     document.getElementsByTagName('head')[0].appendChild(browsiTag);
}

function insertMMDisplayManagerTag() {
    mfdebug("+++ Inserting MM DisplayManager tag");
    if(window.mm_prebid_script_url !== undefined) {
        var s = document.createElement('script');
        s.src = window.mm_prebid_script_url;
        document.getElementsByTagName('head')[0].appendChild(s);
    }
}

var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
var use_mm_prebid = false;
var mm_prebid_rand = Math.floor(Math.random(0,100) * 100);


jQuery(function(){
    mfdebug("++ current device: "+MentalFloss.getCurrentDevice());

    if(document.location.pathname.match(/^\/longform\//) !== null) {
        if(document.location.search.match(/pb=1/)) {
            mm_prebid_rand = 1;
        }
        else if(document.location.search.match(/pb=0/)) {
            mm_prebid_rand = 101;
        }
        mfdebug("mm_prebid_rand: " + mm_prebid_rand);

        // Disable MF Ad Manager + use mm-prebid for 100% of mobile and desktop traffic
        if( (MentalFloss.getCurrentDevice() !== "mobile" && mm_prebid_rand !== 101) || (MentalFloss.getCurrentDevice() === "mobile" && mm_prebid_rand <= 100)) {

            mfdebug("++ disabling ads and using mmDisplayManager for longform template");
            window.disableAds = 1;
            window.use_mm_prebid = true;

            // add the display manager tag if 'spl' param is not set
            if(!getQueryParam('spl')) {
                insertMMDisplayManagerTag();
            }
        }
        else {
            mfdebug("++ using MF/AdManager");
        }

    }

    // Disable MF ad manager and use browsi for non-longform mobile, or any kennections page
    else if((MentalFloss.getCurrentDevice() === "mobile"
        && document.location.pathname.match(/^\/longform\//) === null ) ||
        document.location.pathname.match(/^\/kennections\//))
    {
        mfdebug("+++ Disabling MF ad management");
        window.disableAds = 1;
    }

    if(document.location.pathname.match(/^\/longform\//) === null && document.location.pathname != "/") {
        var isCommerce = false;
        dataLayer.forEach(function(x){
            if(x.contentTags) {
                if(x.contentTags.includes("Smart Shopping")) {
                    isCommerce = true;
                }
            }
        });
        if(!isCommerce) {
            insertBrowsiTag();
        }
    }
    
    if((typeof(window.disableAds) == "undefined" || !window.disableAds) && !use_mm_prebid) {
        googletag.cmd.push(function () {

            // Infinite scroll requires SRA
            mfdebug("++ Enable Single Request");
            googletag.pubads().enableSingleRequest();

            // Disable initial load, we will use refresh() to fetch ads.
            // Calling this function means that display() calls just
            // register the slot as ready, but do not fetch ads for it.
            googletag.pubads().disableInitialLoad();
            googletag.pubads().collapseEmptyDivs();
            // Enable services
            googletag.enableServices();
        });

        (function() {
            mfdebug("++ Inject GPT");
            var gads = document.createElement('script');
            gads.async = true;
            gads.type = 'text/javascript';
            gads.src = 'https://www.googletagservices.com/tag/js/gpt.js';
            var node = document.getElementsByTagName('script')[0];
            node.parentNode.insertBefore(gads, node);
        })();
    }
});




function getQueryParam(name) {
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    for (var i=0;i<vars.length;i++) {
        var pair = vars[i].split("=");
        if(pair[0] == name){return pair[1];}
    }
    return(false);
}

if(!use_mm_prebid) {
    window.AdManager = new AdManager();
}

/*!
 * jQuery Cookie Plugin v1.4.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2006, 2014 Klaus Hartl
 * Released under the MIT license
 */
(function (factory) {
	if (typeof define === 'function' && define.amd) {
		// AMD
		define(['jquery'], factory);
	} else if (typeof exports === 'object') {
		// CommonJS
		factory(require('jquery'));
	} else {
		// Browser globals
		factory(jQuery);
	}
}(function ($) {

	var pluses = /\+/g;

	function encode(s) {
		return config.raw ? s : encodeURIComponent(s);
	}

	function decode(s) {
		return config.raw ? s : decodeURIComponent(s);
	}

	function stringifyCookieValue(value) {
		return encode(config.json ? JSON.stringify(value) : String(value));
	}

	function parseCookieValue(s) {
		if (s.indexOf('"') === 0) {
			// This is a quoted cookie as according to RFC2068, unescape...
			s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
		}

		try {
			// Replace server-side written pluses with spaces.
			// If we can't decode the cookie, ignore it, it's unusable.
			// If we can't parse the cookie, ignore it, it's unusable.
			s = decodeURIComponent(s.replace(pluses, ' '));
			return config.json ? JSON.parse(s) : s;
		} catch(e) {}
	}

	function read(s, converter) {
		var value = config.raw ? s : parseCookieValue(s);
		return $.isFunction(converter) ? converter(value) : value;
	}

	var config = $.cookie = function (key, value, options) {

		// Write

		if (arguments.length > 1 && !$.isFunction(value)) {
			options = $.extend({}, config.defaults, options);

			if (typeof options.expires === 'number') {
				var days = options.expires, t = options.expires = new Date();
				t.setTime(+t + days * 864e+5);
			}

			return (document.cookie = [
				encode(key), '=', stringifyCookieValue(value),
				options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
				options.path    ? '; path=' + options.path : '',
				options.domain  ? '; domain=' + options.domain : '',
				options.secure  ? '; secure' : ''
			].join(''));
		}

		// Read

		var result = key ? undefined : {};

		// To prevent the for loop in the first place assign an empty array
		// in case there are no cookies at all. Also prevents odd result when
		// calling $.cookie().
		var cookies = document.cookie ? document.cookie.split('; ') : [];

		for (var i = 0, l = cookies.length; i < l; i++) {
			var parts = cookies[i].split('=');
			var name = decode(parts.shift());
			var cookie = parts.join('=');

			if (key && key === name) {
				// If second argument (value) is a function it's a converter...
				result = read(cookie, value);
				break;
			}

			// Prevent storing a cookie that we couldn't decode.
			if (!key && (cookie = read(cookie)) !== undefined) {
				result[name] = cookie;
			}
		}

		return result;
	};

	config.defaults = {};

	$.removeCookie = function (key, options) {
		if ($.cookie(key) === undefined) {
			return false;
		}

		// Must not alter options, thus extending a fresh object...
		$.cookie(key, '', $.extend({}, options, { expires: -1 }));
		return !$.cookie(key);
	};

}));
(function() {

    // Lazy Loading
    var cld;
    var cldScript = document.createElement('script');
    cldScript.addEventListener('load', function(){
        cld = cloudinary.Cloudinary.new({cloud: 'mentalfloss'});
    });
    cldScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.10.3/cloudinary-core-shrinkwrap.js';
    var t = document.getElementsByTagName('script')[0];
    t.parentNode.appendChild(cldScript);

    window.lazyLoadOptions = {
        threshold: 600,
        elements_selector: ".lazy",
        callback_reveal: (el) => {
            if(el.hasOwnProperty('data-src')) {
                el.dataset.src = el.dataset.src
                    .replace(/\,(w_\d+)[\/,]/, ',w_auto')
                    .replace(',f_auto', ',dpr_auto,f_auto')
                    .replace(/c_fit,/, 'c_scale,');
                // if (el.dataset.src.includes('w_auto')) {
                // 	const width = Math.ceil(el.offsetWidth / 100) * 100
                // 	el.dataset.src = el.dataset.src.replace('w_auto', `w_${width}`);
                // }
                //el.src = el.dataset.src;
                el.classList.add('cld-responsive');
                cld.responsive()
            }
            if(el.hasOwnProperty('data-srcset')) {
                el.dataset.srcset = el.dataset.srcset
                    .replace(/\,w_\d+\/v/, ',w_auto/v')
                    .replace(',f_auto', ',dpr_auto,f_auto')
                    .replace(/c_fit,/, 'c_scale,');
                // if (el.dataset.srcset.includes('w_auto')) {
                // 	const width = Math.ceil(el.offsetWidth / 100) * 100
                // 	el.dataset.srcset = el.dataset.srcset.replace('w_auto', `w_${width}`);
                // }
                // el.srcset = el.dataset.srcset;
                el.classList.add('cld-responsive');
                cld.responsive();
            }

        }
    };
    window.addEventListener(
        "LazyLoad::Initialized",
        function(e) {
            console.log(e.detail.instance);
        },
        false
    );


})();
function MentalFloss() {

    var syntheticPageviewUrls = [];
    var device;

    // be a singleton
    if ( arguments.callee._singletonInstance )
        return arguments.callee._singletonInstance;
    arguments.callee._singletonInstance = this;

    this.getDeviceBreakpoint = function(type) {
        var prop;
        switch(type) {
            case 'mobile':
                prop = 'margin-left';
                break;
            case 'tablet':
                prop = 'margin-right';
                break;
            default:
                prop = 'margin-top';
        }
        return jQuery('div#cssjsconfig').css(prop);
    }

    this.getCurrentDevice = function() {
        var prop = jQuery('#cssjsconfig').css("vertical-align");
        var device;

        switch(prop) {
            case 'bottom':
                device = 'mobile';
                break;
            case 'middle':
                device = 'tablet';
                break;
            default:
                device = 'desktop';
        }

        return device;
    }

    this.device = this.getCurrentDevice();
    this.isMobile = this.getCurrentDevice() == 'mobile' ? true : false;
    this.isTablet = this.getCurrentDevice() == 'tablet' ? true : false;
    this.isDesktop = this.getCurrentDevice() == 'desktop' ? true : false;

    /*
     * Allows you to push analytics events via the dataLayer
     *
     * ec - analytics event category
     * ea - analytics event action
     * el - analytics event label
     * ev - analytics event value
     */
    this.pushUAEvent = function(category, action, label, value) {
        dataLayer.push({
            'uaEvent.category': category,
            'uaEvent.action': action,
            'uaEvent.label': label,
            'uaEvent.value': value,
            'event': 'uaEvent'
        });
    }

    // used to "lock" a url so synthetic pageview won't be fired
    // twice.  this happens automatically when you call
    // pushSyntheticPageView, but for the url in the initial
    // pageload, you will probably want to lock it using this method
    this.syntheticPageviewLockUrl = function(url) {
        syntheticPageviewUrls.push(url);
    }

    // return urls "locked" for syntheticPageView.  These urls
    // synthetic pageviews will not fire for these urls using
    // the pushSyntheticPageview method
    this.syntheticPageviewUrls = function() {
        return syntheticPageviewUrls;
    }

    this.pushSyntheticPageview = function(url, pageType,id,title, tags, pubdate, authors, articleTemplate ) {
        // don't send the same pageview event more than once per pageload

        if(syntheticPageviewUrls.indexOf(url) < 0) {
            if (url == undefined) url = '';
            if (pageType == undefined) pageType = '';
            if (title == undefined) title = '';
            if (pubdate == undefined) pubdate = '';
            if (tags == undefined) tags = [];
            if (authors == undefined) authors = [];
            if (articleTemplate == undefined) articleTemplate = '';


            syntheticPageviewUrls.push(url);


            dataLayer.push({
                'article.url': url,
                'pagetype': pageType,
                'articleId': id,
                'articleTitle': title,
                'articleTemplate':articleTemplate,
                'contentTags': tags,
                'articleAuthor': authors,
                'articlePublicationTime': pubdate,
                'platform':this.device,
                'property': "mentalfloss.com",
                'language': "en",
                'distributionChannels': "mentalfloss_en",
                'userIsConnected': "logged out",
                'newCookieConsent':"0",
                'anonimized': "0",
                'cookieConsentStatus': "0"

            });
            dataLayer.push({'event': 'pageview'});
        }
        else {
            console.log("Not sending duplicate pageview for "+url);
        }
    }

    this.getQueryParam = function(name) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == name){return pair[1];}
        }
        return(false);
    }

}

var MentalFloss = new MentalFloss();



